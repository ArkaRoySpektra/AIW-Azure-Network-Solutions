# Exercise 6:  Provision Secondary Azure Region Infrastructure 
 
 Duration: 20-30 mins
 
 ## Scenario
 
 Contoso Application is growing in popularity around the world, so they need a supporting infrastructure for the application development team. Contoso wants the virtual machines in the primary and secondary regions to communicate securely over a private network.

 In this section, you will help Contoso in setting up secondary region infrastructure and configure peering connection that allows virtual machine's in primary and secondary to communicate securely on private network
 
 ## Overview
 
Virtual network peering enables you to seamlessly connect two or more Virtual Networks in Azure. The virtual networks appear as one for connectivity purposes. The traffic between virtual machines in peered virtual networks uses the Microsoft backbone infrastructure. Like traffic between virtual machines in the same network, traffic is routed through Microsoft's private network only. To lear more about Vnet peering refer to : ```https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview```
 
 In this exercise, you'll create a Virtual Network in secondary region and deploy a VM within the Vnet. You'll also configure Peering connections between the Vnets and test inter-VM connectivity on your private network.
 
 This exercise includes the following tasks:
 
*  [Task 1 : Provision Virtual Network – 2 (Region-2)](#task-1-provision-virtual-network--2-region-2)

*  [Task 2 : Provision VM in VNET-2](#task-2-provision-sample-vm-in-vnet-2)

*  [Task 3 : Configure VNET Peering](#task-3-configure-vnet-peering)

*  [Task 4 : Validate Inter VM Connectivity on private network](#task-4-validate-inter-vm-connectivity-on-a-private-network)

## Task 1: Provision Virtual Network – 2 (Region-2)

In this task, you will create a virtual network in the secondary region.

1. In the Azure Portal, from the upper left corner select **menu icon with three lines(1)** and then select **Create a resource (2)**.

   ![Create resource](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/createare.png?raw=true)
     
2. In the search box, type **Virtual Network** and click on it.

   ![Create Resource](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/vnetsearch.png?raw=true)
      
3. Click on **Create**.

   ![vnet](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/vnet.png?raw=true)
   
   
3. On the **Basics** tab of the **Create Virtual Network** blade, enter the following information and and select **Next: IP Addresses**.

     - Subscription: Select your subscription.

     - **Resource group (1)**: Select **rg-contoso-prod-westus**

     - **Name: (2)** **vnet-contoso-prod-westus-001**

     - **Region:** **(US) West US**
     
     - Click on **Ip Address (4)**.

   ![second Vnet](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/vnet2.png?raw=true)
       
4. On the **IP Addresses** tab enter the below details:

     - IPv4 address space: **10.2.0.0/16 (1)**
     
     - Click on **+ Add subnet (2)** and follow the below instructions:
  
         - Subnet name (3): **snet-prod-westus-internalserver**
         - Subnet address range (4): **10.2.0.0/24**
         - Click on **Add (5)**
        
     - Select **Review + create (6)**
     
  ![create vnet](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/subnetvnet2.png?raw=true)
       
4. Review the Virtual Machine configuration and select **Create**.

   ![create vnet](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/create5.png?raw=true)
     


## Task 2: Provision VM in VNET-2

In this task, you will deploy secondary region Virtual Macgine in the existing virtual network that you deployed in the previous task.

1. Navigate back to the **Home** page of Azure Portal and click on **Create a resource**.

     ![Create resource](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/Picture4.png?raw=true)
     
2. Go to **Compute (1)** under **Categories** and select **Virtual Machine (2)**.

     ![vm](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/selectvm.png?raw=true)
     
2. Now, click on **Create**

     ![create vm](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/vms.png?raw=true)
     
3.  On the **Basics** tab of **Create a virtual machine** blade, enter the following details:

     - Resource group : Select **<inject key="Resource Group" enableCopy="false"/>** from drop down list **(1)**.
     
     - Name : **<inject key="samplevm" enableCopy="true"/>** **(2)**
      
     - Region : **West US (3)**
     
     - Image : **Windows server 2019 Datacenter-Gen2 (4)**
     
     - Username : **demouser (5)**
     
     
     - Password : **Password.1!! (6)**
     
     
     - Confirm Password : **Password.1!! (7)**
     
     
     - Select **Next : Disks (8)**
     
     
      ![create vm](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/createVM1.png?raw=true)
      
4. Leave everything as **Default** under **Disks** and move to **Networking** tab.
	
5. Under **Networking** tab select the **Virtual network** as **<inject key="VnetName" enableCopy="false"/>**(1) from drop down list and select **Review + create (2)**.

     ![Review and create](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/createVM3.png?raw=true)
     
6. Review the Virtual Network configuration and select **Create**.

     ![create](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/createSamplevm.png?raw=true)

7. Once the deployment is complete, click on **Go to resource**.

     ![goto](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/b.png?raw=true)
     

## Task 3: Configure VNET Peering

In this task, you will configure a peering connection between the two virtual networks that you created earlier.

1. Select **vm-contoso-app-prod-westus-001** from the overview page of the Resource Group **rg-contoso-prod-westus**

    ![vm2](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/vmwest.png?raw=true)

1. From the **Overview** tab of **<inject key="samplevm" enableCopy="false"/>**, select **Virtual network/subnet**.

     ![select vnet](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/vnets.png?raw=true)
   
2. Select **Peerings** under **Settings** from the left navigation menu and select **+ Add**.

     ![peering](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/peerings.png?raw=true)
     
3. Set the following configuration for the new peering. 

    - Peering link name: **vnet-peering-eastus-westus-001**

    - Traffic to remote virtual network: **Allow (default)**

    - Traffic forwarded from remote virtual network: **Allow (default)**

    - Peering link name (Remote virtual network): **vnet-peering-westus-eastus-001**

    - Virtual Network: **vnet-contoso-prod-eastus-001**

    - Traffic to remote virtual network: **Allow (default)**

    - Traffic forwarded from remote virtual network: **Allow (default)**
    
    - Click on **Add**

      ![peering](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/peering2.png?raw=true)


## Task 4: Validate Inter VM Connectivity on a private network. 

In this task, you will test the inter VM connectivity by connecting to the virtual machine in the primary network then initiating a connection to the virtual machine in the secondary network using a private IP address.
1. Navigate back to the Resource Group **rg-contoso-prod-westus** and select **vm-contoso-app-prod-westus-001** from the overview page.

    ![vm](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/rgg.png?raw=true)
   
3. From the **Overview (1)** of **<inject key="samplevm" enableCopy="false"/>**, select **Connect (2)** to connect the VM using **RDP**

     ![vmto rdp](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/rdpf.png?raw=true)
     
4. Select **Download RDP File** and then open it once it has been downloaded.

     ![rdp](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/downloadd.png?raw=true)
     
5. When you are prompted with the Remote Desktop Connection box, select **Connect**

     ![connect](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/connect.png?raw=true)
     
6. To login into the Virtual Machine use these credentials:

     - Username: **demouser**

     - Password: **Password.1!!**

7. If you are asked with a dialogue box after entering your credentials, select **Yes**.

8. Now, from your Azure Portal navigate to the resource group **rg-contoso-prod-eastus** and select private IP Address of **vm-contoso-app-prod-westus-002** from the overview page

     ![privateip](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/privateipa.png?raw=true)
     
9. Now, from the samplevm search for the **Remote desktop app** and select it.

     ![rdp](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/rdpconnection.png?raw=true)
 
10. Now, provide the **Private IP address (1)** that you copied in the **step-8** and and click on **Connect**.

     ![private](https://github.com/CloudLabsAI-Azure/AIW-Azure-Network-Solutions/blob/main/media/enterip.png?raw=true)
     
11. Use the same credentials as in **step 6** to connect to the Remote Desktop App.

     - Username : **demouser**

     - Password: **Password.1!!**

12.  Notice that you can connect to the VM using a private IP address which means you've successfully set up inter-VM connectivity on your private network.


### Summary

In this exercise you have covered the following:

- Setup Virtual Network in a secondary region.
- Deployed Virtual Machine in secondary vnet.
- Created peering between primary and Virtual Network.
- Tested intersite connectivity.
